rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isValidProduct() {
      let incoming = request.resource.data;
      return incoming.name is string && incoming.name.size() > 0 &&
             incoming.price is number && incoming.price >= 0 &&
             incoming.description is string && incoming.description.size() > 0 &&
             incoming.category is string &&
             incoming.stock is number && incoming.stock >= 0 &&
             incoming.createdAt is timestamp &&
             incoming.images is list &&
             incoming.variants is list;
    }
    
    function isValidOrder() {
      let incoming = request.resource.data;
      return incoming.userId is string &&
             incoming.status in ['pending', 'processing', 'completed', 'cancelled', 'shipped', 'delivered'] &&
             incoming.total is number && incoming.total >= 0 &&
             incoming.items is list &&
             incoming.shippingDetails is map &&
             incoming.shippingDetails.keys().hasAll(['fullName', 'email', 'phone', 'streetAddress', 'city', 'state', 'postalCode', 'country']) &&
             incoming.paymentStatus in ['pending', 'completed', 'failed', 'refunded'] &&
             incoming.createdAt is timestamp;
    }
    
    function isValidReview() {
      let incoming = request.resource.data;
      return incoming.userId is string &&
             incoming.productId is string &&
             incoming.rating is number &&
             incoming.rating >= 1 && 
             incoming.rating <= 5 &&
             incoming.text is string &&
             incoming.text.size() > 0 &&
             incoming.createdAt is timestamp &&
             incoming.userName is string;
    }

    function isValidShippingDetails() {
      let details = request.resource.data.shippingDetails;
      return details.fullName is string && details.fullName.size() > 0 &&
             details.email is string && details.email.matches('^[^@]+@[^@]+\\.[^@]+$') &&
             details.phone is string &&
             details.streetAddress is string && details.streetAddress.size() > 0 &&
             details.city is string && details.city.size() > 0 &&
             details.state is string &&
             details.postalCode is string &&
             details.country is string;
    }

    function isValidCartItem() {
      let item = request.resource.data;
      return item.productId is string &&
             item.quantity is number &&
             item.quantity > 0 &&
             item.price is number &&
             item.price >= 0;
    }

    // Products collection rules
    match /products/{productId} {
      allow read: if true;
      allow list: if true;  // Allow querying products
      allow create: if isAdmin() && isValidProduct();
      allow update: if isAdmin() && 
                   (isValidProduct() || 
                    request.resource.data.diff(resource.data).affectedKeys()
                    .hasOnly(['stock', 'price', 'updatedAt']));
      allow delete: if isAdmin();
      
      // Product reviews subcollection
      match /reviews/{reviewId} {
        allow read, list: if true;  // Allow reading and querying reviews
        allow create: if isAuthenticated() && 
                     isValidReview() &&
                     request.resource.data.userId == request.auth.uid &&
                     !exists(/databases/$(database)/documents/products/$(productId)/reviews/$(request.auth.uid));
        allow update: if isOwner(resource.data.userId) && 
                     isValidReview() &&
                     request.resource.data.userId == resource.data.userId &&
                     request.resource.data.createdAt == resource.data.createdAt;
        allow delete: if isOwner(resource.data.userId) || isAdmin();
      }
    }

    // Users collection rules
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isAuthenticated() && request.auth.uid == userId && 
                   request.resource.data.keys().hasAll(['email', 'displayName', 'createdAt']);
      allow update: if (isOwner(userId) || isAdmin()) && 
                   request.resource.data.diff(resource.data).affectedKeys()
                   .hasAny(['displayName', 'phone', 'address', 'photoURL', 'preferences', 'lastLogin', 'updatedAt']);
      allow delete: if isAdmin();
      
      // User's orders subcollection
      match /orders/{orderId} {
        allow read: if isOwner(userId) || isAdmin();
        allow write: if false; // Orders should only be written to main orders collection
      }
    }

    // Orders collection rules
    match /orders/{orderId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      
      // Allow listing and querying orders
      match /{document=**} {
        allow read: if isAuthenticated() && (
          resource.data.userId == request.auth.uid || isAdmin()
        );
      }
      
      allow create: if isAuthenticated() && 
                   request.resource.data.userId == request.auth.uid &&
                   isValidOrder() &&
                   isValidShippingDetails();
                   
      allow update: if (isAdmin() && 
                    request.resource.data.diff(resource.data).affectedKeys()
                    .hasAny(['status', 'paymentStatus'])) || 
                   (isOwner(resource.data.userId) && 
                    request.resource.data.diff(resource.data).affectedKeys()
                    .hasOnly(['status']) &&
                    resource.data.status != 'cancelled' &&
                    request.resource.data.status == 'cancelled');
                    
      allow delete: if isAdmin();
    }

    // Cart collection rules
    match /carts/{userId} {
      allow read, list: if isOwner(userId);
      allow create: if isOwner(userId) && 
                   request.resource.data.keys().hasAll(['updatedAt', 'items']) &&
                   request.resource.data.items is list;
      allow update: if isOwner(userId) && 
                   request.resource.data.keys().hasAll(['updatedAt', 'items']) &&
                   request.resource.data.items is list;
      allow delete: if isOwner(userId);
      
      match /items/{itemId} {
        allow read, list: if isOwner(userId);
        allow create: if isOwner(userId) && 
                     isValidCartItem() &&
                     exists(/databases/$(database)/documents/products/$(request.resource.data.productId));
        allow update: if isOwner(userId) && 
                     isValidCartItem() &&
                     exists(/databases/$(database)/documents/products/$(request.resource.data.productId));
        allow delete: if isOwner(userId);
      }
    }

    // Wishlist collection rules
    match /wishlists/{userId} {
      allow read: if isOwner(userId);
      allow create, update: if isOwner(userId) && 
                          request.resource.data.keys().hasAll(['updatedAt']);
      allow delete: if isOwner(userId);
      
      match /items/{itemId} {
        allow read: if isOwner(userId);
        allow create, update: if isOwner(userId) && 
                            request.resource.data.keys().hasAll(['productId', 'addedAt']);
        allow delete: if isOwner(userId);
      }
    }

    // Admins collection rules
    match /admins/{adminId} {
      allow read: if isAuthenticated() && request.auth.uid == adminId;
      allow create, update: if isAdmin() && request.resource.data.keys().hasAll(['role']);
      allow delete: if isAdmin() && request.auth.uid != adminId; // Admin cannot delete themselves
    }

    // Categories collection rules
    match /categories/{categoryId} {
      allow read: if true;
      allow create, update: if isAdmin() && 
                          request.resource.data.keys().hasAll(['name', 'description', 'createdAt']);
      allow delete: if isAdmin();
    }

    // Analytics collection rules
    match /analytics/{docId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }

    // Settings collection rules
    match /settings/{settingId} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
} 